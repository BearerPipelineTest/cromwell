steps:

  # NOTE: we are only computing the cache-key based on TWO files (build.sbt and Dependencies.scala)  
  - id: 'restore cache'
    name: 'gcr.io/$PROJECT_ID/restore_cache'
    args:
      - '--bucket=gs://cromwell-cloudbuild-sbt-cache'
      - '--key=build-cache-$( checksum build.sbt project/Dependencies.scala )'
    waitFor: ['-']

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: 'bash'
    args: [ '-c', "gcloud secrets versions access latest --secret=vault_role_id > .vault_role_id && gcloud secrets versions access latest --secret=vault_secret_id > .vault_secret_id"]
    waitFor: ['-']
  
  - id: build-cromwell
    # Container is https://hub.docker.com/r/hseeberger/scala-sbt plus Docker, vault, git-secrets
    name: us.gcr.io/broad-dsde-cromwell-dev/cromwell-cloudbuild-base@sha256:220aedc403a1d10fa8748fe18b7c62aaa2fec108430063cf8e03fc58edeed3ae
    entrypoint: bash
    args:
      - src/ci/bin/testCentaurTes.sh
    env:
    - 'BUILD_TYPE=centaurTes'
    - 'BUILD_MYSQL=5.7'
    - 'CLOUD_BUILD=true'
    - 'crmdbg=y'
    timeout: 3600s
    waitFor: ['restore cache']

  - id: 'save cache'
    name: 'gcr.io/$PROJECT_ID/save_cache'
    args:
      - '--bucket=gs://cromwell-cloudbuild-sbt-cache'
      - '--key=build-cache-$( checksum build.sbt project/Dependencies.scala )'
      - '--path=/workspace/.ivy2/cache'
      - '--no-clobber'
    waitFor: ['build-cromwell']

options:
  machineType: 'N1_HIGHCPU_32'
  diskSizeGb: '500'
timeout: 3600s
